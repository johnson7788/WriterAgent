import uuid
import httpx
import time
from a2a.client import A2AClient
import asyncio
from a2a.types import (MessageSendParams, SendMessageRequest, SendStreamingMessageRequest)

async def httpx_client():
    timeout = httpx.Timeout(30.0)  # 设置为 30 秒
    async with httpx.AsyncClient(timeout=timeout) as httpx_client:
        # 初始化客户端（确保base_url包含协议头）
        client = await A2AClient.get_client_from_agent_card_url(
            httpx_client, 'http://localhost:10051'  # 确保此处是完整 URL
        )

        # 生成唯一请求ID
        request_id = uuid.uuid4().hex
        # 构造消息参数
        send_message_payload = {
            'message': {
                'role': 'user',
                'parts': [{'type': 'text', 'text': prompt}],
                'messageId': request_id
            }
        }
        print(f"发送message信息: {send_message_payload}")
        # 流式请求的示例
        streaming_request = SendStreamingMessageRequest(
            id=request_id,
            params=MessageSendParams(**send_message_payload)  # 同样的 payload 可以用于非流式请求
        )

        stream_response = client.send_message_streaming(streaming_request)
        async for chunk in stream_response:
            print(time.time())
            print(chunk.model_dump(mode='json', exclude_none=True))

if __name__ == '__main__':
    # 全部
    # prompt = """我将为您搜索非小细胞肺癌相关的研究进展文献，然后生成详细的大纲。我将为您搜索非小细胞肺癌相关的研究进展文献，然后生成详细的大纲。基于检索到的文献资料，我现在为您生成非小细胞肺癌研究进展的严谨生物医学综述大纲：\n\n# 非小细胞肺癌精准治疗研究进展\n\n## 摘要\n- 背景：非小细胞肺癌占所有肺癌病例的85%，是全球癌症死亡率首位\n- 目的：综述非小细胞肺癌精准治疗的最新进展与转化应用\n- 方法：系统检索近5年权威指南、临床试验与基础研究证据\n- 主要发现：免疫治疗、靶向治疗、ADC药物联合策略取得突破性进展\n- 结论与展望：从分子分型到个体化治疗的精准医学范式正在重塑治疗格局\n- 关键词：非小细胞肺癌；免疫治疗；靶向治疗；分子分型；精准医学；临床试验\n\n## 1. 引言与疾病负担\n### 1.1 流行病学/流行现状与分型 ([新民晚报][2]),([JAMA子刊][4])\n### 1.2 现有标准方案/路径与疗效边界 ([非小细胞肺癌主要治疗原则][1]),([CheckMate-816][17])\n### 1.3 关键痛点与临床/研究难题 ([NSCLC免疫治疗多点开花][11]),([EGFR/ALK耐药][22])\n### 1.4 研究模型/证据体系需求 ([张泽民课题组][5]),([单细胞图谱][9])\n\n## 2. 免疫治疗技术概述\n### 2.1 定义与发展脉络 ([PD-1/PD-L1抑制剂][15]),([免疫治疗崛起][11])\n### 2.2 建立/实验/采集流程与条件 ([新辅助免疫治疗][17]),([同步放化疗][4])\n### 2.3 质量控制与表征 ([病理完全缓解率][17]),([无进展生存期][4])\n### 2.4 与替代模型比较 ([化疗vs免疫][11]),([靶向治疗比较][20])\n### 2.5 资源/资料库与数据共享 ([Cell资源文章][9]),([专家共识][6])\n\n## 3. 分子机制与生物学基础\n### 3.1 经典通路/网络 ([EGFR信号通路][20]),([ALK重排][24])\n### 3.2 可塑性与表观遗传/细胞状态转变 ([免疫微环境异质性][5]),([TIME调控][8])\n### 3.3 微环境/外部因子 ([肿瘤相关巨噬细胞][12]),([机械应力][13])\n### 3.4 分层因素 ([驱动基因分型][20]),([PD-L1表达][43])\n### 3.5 动态演化与耐受/耐药/复发的分子基础 ([EGFR-TKI耐药][22]),([免疫逃逸][7])\n\n## 4. 在机制研究中的应用\n### 4.1 模型构建与诱导策略 ([新辅助治疗模型][17]),([长期暴露模型][13])\n### 4.2 基因编辑/功能验证与合成致死/依赖性筛选 ([Jagged2靶点][7]),([Piezo1机制][13])\n### 4.3 多组学整合 ([单细胞蛋白质组][38]),([空间转录组][5])\n### 4.4 共培养/微环境重建与仿真平台 ([TLR4纳米激动剂][12]),([巨噬细胞复极化][12])\n### 4.5 典型案例 ([CheckMate-816][17]),([AEGEAN研究][18]),([OptiTROP-Lung01][19])\n### 4.6 组合策略优化与相互作用评估 ([ADC+免疫联合][14]),([联合治疗评分][46])\n\n## 5. 转化与个体化应用\n### 5.1 工作流与报告 ([围手术期规范化][6]),([基因检测流程][20])\n### 5.2 与临床结局的相关性与证据等级 ([5年生存率][17]),([长期生存获益][17])\n### 5.3 伴随诊断/分层与综合评分 ([分子残留病灶][18]),([ctDNA动态][18])\n### 5.4 医疗流程/MDT与经济学 ([成本效果分析][28]),([支付可及性][11])\n### 5.5 真实世界落地与教训 ([临床实践转化][40]),([治疗失败范式][23])\n\n## 6. 计算与数据科学助力\n### 6.1 特征工程与建模 ([机器学习算法][39]),([生物信息学分析][31])\n### 6.2 泛化/外部验证与隐私 ([多中心验证][49]),([数据安全][39])\n### 6.3 数字孪生/虚拟试验与策略优化 ([适应性治疗][30]),([虚拟临床试验][46])\n### 6.4 组合/剂量/方案的算法设计与自适应试验 ([OptiTROP研究][19]),([剂量优化][45])\n\n## 7. 局限性与挑战\n### 7.1 技术与生物学局限 ([免疫治疗异质性][8]),([靶向治疗耐药][22])\n### 7.2 标准化与质量体系 ([规范化共识][6]),([跨中心一致性][49])\n### 7.3 法规伦理与数据共享 ([知情同意][39]),([生物安全][37])\n### 7.4 可扩展与成本 ([治疗费用][28]),([自动化需求][46])\n### 7.5 结果解释与不确定性沟通 ([临床阈值][18]),([可操作性][27])\n\n## 8. 未来方向与前景\n### 8.1 新型免疫治疗/多靶点平台 ([双特异性抗体][41]),([PD-1/VEGF双抗][41])\n### 8.2 替代材料与GMP级规范化 ([纳米颗粒载体][12]),([生物类似药][49])\n### 8.3 与放疗/介入/新兴疗法的联合评估 ([同步放化疗优化][48]),([介入联合][47])\n### 8.4 微生物/环境精准干预与逆转策略 ([微环境调控][12]),([免疫复极化][12])\n### 8.5 快速建模/自动化与\"床旁\"平台 ([快速检测技术][37]),([即时诊断][32])\n### 8.6 试验生态与真实世界证据融合 ([适应性试验][30]),([平台试验][40])\n\n## 9. 结语\n- 非小细胞肺癌精准治疗从分子分型到临床实践的转化路径与关键里程碑\n- 多学科协作与真实世界证据融合推动标准化落地的协同发展\n\n## 10. 附录\n- 术语/缩写表；图表清单；补充方法"""
    # mini
    prompt = """我将为您搜索非小细胞肺癌相关的研究进展文献，然后生成详细的大纲。我将为您搜索非小细胞肺癌相关的研究进展文献，然后生成详细的大纲。基于检索到的文献资料，我现在为您生成非小细胞肺癌研究进展的严谨生物医学综述大纲：

# 非小细胞肺癌精准治疗研究进展

## 摘要
- 背景：非小细胞肺癌占所有肺癌病例的85%，是全球癌症死亡率首位
- 目的：综述非小细胞肺癌精准治疗的最新进展与转化应用
- 方法：系统检索近5年权威指南、临床试验与基础研究证据
- 主要发现：免疫治疗、靶向治疗、ADC药物联合策略取得突破性进展
- 结论与展望：从分子分型到个体化治疗的精准医学范式正在重塑治疗格局
- 关键词：非小细胞肺癌；免疫治疗；靶向治疗；分子分型；精准医学；临床试验

## 1. 引言与疾病负担
### 1.1 流行病学/流行现状与分型 ([新民晚报][2]),([JAMA子刊][4])
### 1.2 现有标准方案/路径与疗效边界 ([非小细胞肺癌主要治疗原则][1]),([CheckMate-816][17])
### 1.3 关键痛点与临床/研究难题 ([NSCLC免疫治疗多点开花][11]),([EGFR/ALK耐药][22])
### 1.4 研究模型/证据体系需求 ([张泽民课题组][5]),([单细胞图谱][9])

## 2. 免疫治疗技术概述
### 2.1 定义与发展脉络 ([PD-1/PD-L1抑制剂][15]),([免疫治疗崛起][11])
### 2.2 建立/实验/采集流程与条件 ([新辅助免疫治疗][17]),([同步放化疗][4])
### 2.3 质量控制与表征 ([病理完全缓解率][17]),([无进展生存期][4])
### 2.4 与替代模型比较 ([化疗vs免疫][11]),([靶向治疗比较][20])
### 2.5 资源/资料库与数据共享 ([Cell资源文章][9]),([专家共识][6])

## 9. 结语
- 非小细胞肺癌精准治疗从分子分型到临床实践的转化路径与关键里程碑
- 多学科协作与真实世界证据融合推动标准化落地的协同发展

## 10. 附录
- 术语/缩写表；图表清单；补充方法
"""
    asyncio.run(httpx_client())
